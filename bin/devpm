#!/usr/bin/env bash
set -euo pipefail

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
DEVPM_ROOT="$(cd -P "$(dirname "$SOURCE")/.." && pwd)"

source "$DEVPM_ROOT/lib/utils.sh"
source "$DEVPM_ROOT/lib/nest.sh"

command=${1:-}

case "$command" in
  -h|--help| h | help)
    show_help
    exit 0
    ;;
esac

case "$command" in
  new)
  stack=${2:-}
  name=${3:-}
  flag=${4:-}

  [[ -z "$stack" || -z "$name" ]] && error "Uso: devpm new nest <project-name> [--docker]"

  case "$stack" in
    nest)
      if [[ "$flag" == "--docker" ]]; then
        create_nest_project "$name" true
      else
        create_nest_project "$name"
      fi
      ;;
    *)
      error "Stack no soportado: $stack"
      ;;
  esac
  ;;

start)
  name=${2:-}
  start_project "$name"
  ;;
  help|"")
    show_help
    ;;
  *)
    error "Comando desconocido: $command"
    ;;
esac
